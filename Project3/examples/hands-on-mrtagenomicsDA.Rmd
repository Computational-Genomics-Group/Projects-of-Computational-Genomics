---
title: "Differential Abundance analysis"
author: "Barbara Di Camillo, Marco Cappellato"
output: 
  html_document:
    theme: readable
    toc: yes
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=6, fig.align = 'center', fig.path = "fig/")
```


```{r}
# Clean Global Environment
rm(list=ls())

# load preprocessed data (from the last hands on))
load("preprocessing.RData")
```

## ALDEx2


```{r message=FALSE}
library(ALDEx2)

#INPUT PARAMETERS... SEE HELP
#...
#"t" runs Welch's t and Wilcoxon tests. "kw" runs Kruskal-Wallace and glm tests.


aldex_results<- aldex(reads = feature_table_gen, conditions =label_samples$DiseaseState, mc.samples = 128,test = "t")
```


* ***rab.all:*** a vector containing the median clr value for each feature in all samples 
* ***rab.win.CDI:*** a vector containing the median clr value for each feature in condition A
* ***rab.win.H:*** a vector containing the median clr value for each feature in condition B
* ***diff.btw:*** a vector containing the per-feature median difference between condition A and B
* ***diff.win:*** a vector containing the per-feature maximum median difference between Dirichlet instances within conditions
* ***effect:*** a vector containing the per-feature *effect size* : $\dfrac{diff.btw}{max(diff.win)}$.
* ***overlap:*** a vector containing the per-feature proportion of effect size that is 0 or less (no-effect)
* ***we.ep:***  a vector containing the expected p-value of Welch's t-test for each feature
* ***we.eBH:***  a vector containing the corresponding expected value of the Benjamini-Hochberg corrected p-value for each feature
* ***wi.ep:***  a vector containing the expected p-value of the Wilcoxon Rank Sum test for each feature
* ***wi.eBH:***  a vector containing the corresponding expected value of the Benjamini-Hochberg corrected p-value for each feature

Keep in mind that if taxa have 0 counts across all subjects they are removed before runing the method
Therefore you might have a number of taxa in output which is lower than the number of taxa in input

```{r message=FALSE}
head(aldex_results)
```



## ANCOM-II

The method is not available in R, but you can download it from [GitHub](https://github.com/FrederickHuangLin/ANCOM) A copy is on stem. 

```{r message = FALSE}
source("ancom.R")
```

There are 2 functions
*feature_table_pre_process* implements the preprocessing 

* ***feature_table:*** Data.frame or count matrix with taxa on rows
* ***meta_data:*** Data.frame or matrix of metadata
* ***sample_var:*** name of the column in meta_data with samples IDs.
* ***group_var:*** Nname of the column in meta_data with
* ***out_cut:*** number between 0 and 1. Observations below *out_cut* will be considered outliers zeros 
* ***zero_cut:*** number between 0 and 1. This is parameter h used to further define the outlier zeros
* ***lib_cut:*** samples with seq depth lower than lib_cut are excluded from the analysis
* ***neg_lb:*** neg_lb = FALSE considers biological 0 (structural 0) only counts that are 0 acroos all samples within one group. If TRUE also small values are considered as 0.


```{r}
# data.frame metadata
metadata<- data.frame("sample_id"=colnames(feature_table_gen), "group"=label_samples$DiseaseState)

# Preprocessing degli zeri di ANCOM-II
# (alcuni parametri non hanno default-->settati con i default di ANCOM-BC)
prepro<- feature_table_pre_process(feature_table = feature_table_gen, meta_data = metadata,sample_var = "sample_id", group_var = "group", out_cut = 0.05, zero_cut = 0.9, lib_cut = 1000, neg_lb = T)
```

The output is a list:

* ***feature_table:*** Data.frame or count matrix with taxa on rows
* ***meta_data:*** Data.frame or matrix of metadata
* ***structure_zeros:*** matrix (taxa on rows and groups on columns) with 1 indicating that the corresponding taxon is a biological (i.e. structural) 0


```{r results='hide'}
# Let's run ANCOM-II
feature_table<- prepro$feature_table
meta_data<- prepro$meta_data
struc_zero<- prepro$structure_zeros

ancom_results <- ANCOM(feature_table = feature_table, meta_data = meta_data, 
                       struc_zero = struc_zero, main_var = "group", p_adj_method = "BH", 
                       alpha = 0.05)
```
The output is a list:

* ***p_data:*** Matrix of p_values between taxa (pairwise)
* ***q_data:*** Matrix of p_values between taxa (pairwise)
* ***out:*** Data.frame with W statistics for each taxon. Columns indicates different cutoffs on W (0,9, 0,8, 0,7, 0,6). TRUE or FALSE indicate if the taxon pass the threshold (is DA)
* ***fig:*** Volcano plot (ggplot object) of W vs CLR. 


```{r ancom_volcano}
plot(ancom_results$fig)
ancom_results[[3]]
```

Let's analyze the statistic W

```{r W-statistic}

W_stat<- ancom_results$out$W[is.finite(ancom_results$out$W)]
n_taxa<- length(W_stat) 


plot(ecdf(W_stat[is.finite(W_stat)]), main ="Empirical cumulative distribution function for W ", xlab = "W")
abline(v = n_taxa*0.6, col = "red")
abline(v = n_taxa*0.7, col = "blue")
abline(v = n_taxa*0.8, col = "green")
abline(v = n_taxa*0.9, col = "orange")
legend(30, 1, legend=c("detected_06", "detected_07", "detected_08", "detected_09"), 
       col=c("red", "blue", "green", "orange"), lty = 1)
```
